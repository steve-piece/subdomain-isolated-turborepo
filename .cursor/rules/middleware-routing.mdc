<!-- .cursor/rules/middleware-routing.mdc -->
---
globs: apps/protected/middleware.ts
alwaysApply: false
---

# Middleware Routing Rules

- Use `extractSubdomainFromHostname()` from `@workspace/ui/lib/subdomains`.
- If a subdomain exists and path does not start with `/s/` (and is not `/_next`, `/api`, or static):
  - Rewrite to `/s/${subdomain}${pathname}`.
- If path starts with `/s/${subdomain}`:
  - Redirect to the clean path without `/s/${subdomain}`.
- Never read or mutate sessions in middleware; keep it Edge-compatible.
- Ensure matcher excludes static assets and Next internals (`_next/static`, `_next/image`, `favicon.ico`, and common image extensions).
